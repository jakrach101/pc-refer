<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ใบส่งตัว Palliative Care</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=TH+Sarabun+New:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>ใบส่งตัว Palliative Care</h1>
      <p class="sub">MVP v1 — ทำงานในเบราว์เซอร์ ไม่ต้องติดตั้ง <span id="saveStatus" class="save-status"></span></p>
    </header>
    <main>
      <section class="card">
        <h2>สถานพยาบาล & วันที่</h2>
        <div class="grid">
          <label>
            หน่วยงานต้นทาง
            <input id="fromFacility" placeholder="เช่น คลินิกเบาใจ รพ.กาฬสินธุ์" />
          </label>
          <label>
            ปลายทาง (Primary: รพ.สต. ใกล้บ้าน)
            <input id="toFacilityPrimary" placeholder="เช่น รพ.สต.บ้าน..." />
          </label>
          <label>
            ปลายทาง (Secondary: รพช.)
            <input id="toFacilitySecondary" placeholder="เช่น รพช...." />
          </label>
          <label>
            ปลายทาง (Tertiary: รพท./รพศ.)
            <input id="toFacilityTertiary" placeholder="เช่น รพท.... / รพศ...." />
          </label>
          <label>
            วันที่ส่งต่อ
            <input id="refDate" type="date" />
          </label>
        </div>
      </section>

      <section class="card">
        <h2>ข้อมูลผู้ป่วย</h2>
        <div class="grid">
          <label>ชื่อ-สกุล <input id="pName" aria-label="ชื่อ-นามสกุลผู้ป่วย" /></label>
          <label>อายุ (ปี) <input id="pAge" type="number" min="0" aria-label="อายุผู้ป่วยเป็นปี" aria-describedby="age-hint" /></label>
          <label>HN <input id="pHN" aria-label="Hospital Number" /></label>
          <label>เลขบัตรประชาชน <input id="pCID" aria-label="เลขบัตรประชาชน 13 หลัก" maxlength="17" /></label>
          <label class="span-2">ที่อยู่ <input id="pAddress" aria-label="ที่อยู่ผู้ป่วย" /></label>
        </div>
        <div>
          <h3 style="margin:12px 0 8px 2px;font-size:16px">ผู้ดูแล <span class="muted" style="font-size:13px">(คนแรก = ผู้ดูแลหลัก)</span></h3>
          <div id="caregiversList"></div>
          <button id="addCaregiver" type="button" class="small" style="margin-top:8px">+ เพิ่มผู้ดูแล</button>
        </div>
      </section>

      <section class="card">
        <h2>วัตถุประสงค์การส่งต่อ</h2>
        <div id="purposeChips" class="chips">
          <label><input type="checkbox" value="ดูแลต่อเนื่องใกล้บ้าน"> ดูแลต่อเนื่องใกล้บ้าน</label>
          <label><input type="checkbox" value="ดูแลประคับประคองที่บ้าน"> ดูแลประคับประคองที่บ้าน</label>
          <label><input type="checkbox" value="ติดตามเยี่ยมบ้าน"> ติดตามเยี่ยมบ้าน</label>
          <label><input type="checkbox" value="ดูแลระยะใกล้เสียชีวิต"> ดูแลระยะใกล้เสียชีวิต</label>
        </div>
      </section>

      <section class="card">
        <h2>Advance Care Plan (ACP)</h2>
        <div id="acpChips" class="chips">
          <label><input type="checkbox" value="No CPR"> No CPR</label>
          <label><input type="checkbox" value="No ETT"> No ETT</label>
          <label><input type="checkbox" value="Place of death at home"> Place of death at home</label>
          <label><input type="checkbox" value="Off ETT at home"> Off ETT at home</label>
          <label><input type="checkbox" value="ยังไม่ตัดสินใจ"> ยังไม่ตัดสินใจ</label>
        </div>
      </section>

      <section class="card">
        <h2>จิตสังคม–จิตวิญญาณ</h2>
        <div class="grid">
          <label>ผู้รับทราบการวินิจฉัย/พยากรณ์ <input id="informedBy" /></label>
          <label>การอยู่อาศัย
            <select id="living">
              <option value="">— เลือก —</option>
              <option>อยู่ลำพัง</option>
              <option>อยู่กับครอบครัว</option>
              <option>มีผู้ดูแลรับจ้าง</option>
            </select>
          </label>
          <label class="span-2">ความห่วงกังวล/ความต้องการ <input id="concerns" /></label>
          <label class="span-2">Perception (ผู้ป่วย) <input id="perceptionPatient" placeholder="ตัวอย่าง: มองว่าตนเอง…" /></label>
          <label class="span-2">Perception (ญาติ) <input id="perceptionFamily" placeholder="ตัวอย่าง: ญาติคิดว่า…" /></label>
          <label class="span-2">Conspiracy of silence <input id="conspiracy" placeholder="ตัวอย่าง: มี/ไม่มี + รายละเอียด" /></label>
        </div>
      </section>

      <section class="card">
        <h2>ข้อมูลทางการแพทย์</h2>
        <div class="grid">
          <label class="span-2">Diagnosis <input id="dx" aria-label="การวินิจฉัยโรค" /></label>
          <label>PPS (%) <input id="pps" type="number" min="10" max="100" step="10" aria-label="Palliative Performance Scale เปอร์เซ็นต์" /></label>
          <label>GFR (mL/min/1.73m²) <input id="gfr" type="number" min="0" max="200" step="1" placeholder="eGFR (mL/min/1.73m²)" aria-label="Glomerular Filtration Rate" /></label>
          <label>Hct (%) <input id="hct" type="number" min="0" max="100" aria-label="Hematocrit เปอร์เซ็นต์" /></label>
          <label>Alb (g/dL) <input id="alb" type="number" step="0.1" aria-label="Albumin กรัมต่อเดซิลิตร" /></label>
        </div>
        <div class="grid">
          <label>Metastasis</label>
          <div id="metastasisChips" class="chips span-2">
            <label><input type="checkbox" value="Bone"> Bone</label>
            <label><input type="checkbox" value="Brain"> Brain</label>
            <label><input type="checkbox" value="Liver"> Liver</label>
            <label><input type="checkbox" value="Lung"> Lung</label>
            <label><input type="checkbox" value="Lymph nodes"> Lymph nodes</label>
          </div>
          <label>การรักษาที่ผ่านมา</label>
          <div id="treatmentChips" class="chips span-2">
            <label><input type="checkbox" value="Chemo"> Chemo</label>
            <label><input type="checkbox" value="RT"> RT</label>
            <label><input type="checkbox" value="Surgery"> Surgery</label>
            <label><input type="checkbox" value="Targeted therapy"> Targeted</label>
            <label><input type="checkbox" value="Immunotherapy"> Immuno</label>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Symptoms & Vital signs</h2>
        <div class="grid">
          <label>ปวดบริเวณ <input id="painSite" aria-label="บริเวณที่ปวด" /></label>
          <label>คะแนนปวด (PS) <input id="painScore" type="number" min="0" max="10" aria-label="Pain Score 0-10" /></label>
          <label>Dyspnea score <input id="dyspneaScore" type="number" min="0" max="10" aria-label="Dyspnea Score 0-10" /></label>
          <label>SpO2 (%) <input id="spo2" type="number" min="0" max="100" aria-label="Oxygen Saturation เปอร์เซ็นต์" /></label>
          <label>RR (ครั้ง/นาที) <input id="vsRR" type="number" min="0" aria-label="Respiratory Rate ครั้งต่อนาที" /></label>
          <label>BP (mmHg) <input id="bp" placeholder="เช่น 120/80" aria-label="Blood Pressure" /></label>
          <label>HR (ครั้ง/นาที) <input id="hr" type="number" min="0" aria-label="Heart Rate ครั้งต่อนาที" /></label>
          <label>GCS <input id="gcs" placeholder="เช่น E4V5M6" aria-label="Glasgow Coma Scale" /></label>
          <label>คลื่นไส้/อาเจียน</label>
          <div id="nauseaChips" class="chips span-2">
            <label><input type="radio" name="nausea" value="มี"> มี</label>
            <label><input type="radio" name="nausea" value="ไม่มี"> ไม่มี</label>
          </div>
          <label class="span-2">อาการอื่นๆ <input id="others" /></label>
        </div>
      </section>

      <section class="card">
        <h2>แผนยา / อุปกรณ์</h2>
        <div class="row">
          <label class="muted">Type</label>
          <div id="orderTypeChips" class="chips">
            <label><input type="radio" name="orderType" value="po" checked> PO/SL</label>
            <label><input type="radio" name="orderType" value="po_prn"> PO/SL PRN</label>
            <label><input type="radio" name="orderType" value="inj_prn"> Inject PRN</label>
            <label><input type="radio" name="orderType" value="inf"> Infusion</label>
          </div>
        </div>

        <div id="singleOrder">
          <div class="med-order-form">
            <!-- Main Input Row -->
            <div class="med-input-row">
              <div class="med-field med-field-grow">
                <label class="med-label">ชื่อยา</label>
                <input id="drugName" placeholder="เช่น MST 30 mg/tab" list="formulary" />
              </div>

              <div class="med-field">
                <label class="med-label">
                  ขนาดยา (dose)
                  <span id="doseUnitLabel" class="unit-badge"></span>
                </label>
                <input id="dose" type="number" min="0" step="0.5" placeholder="1" />
              </div>

              <div class="med-field med-field-grow">
                <label class="med-label">วิธีใช้</label>
                <input id="freq" placeholder="q12h, bid, tid" list="freqList" />
              </div>

              <div class="med-field med-field-qty">
                <label class="med-label">
                  จำนวน
                  <span id="qtyPackLabel" class="pack-info"></span>
                </label>
                <div class="qty-input-wrapper">
                  <input id="qty" type="number" min="0" step="1" placeholder="จำนวน" required />
                  <span class="qty-calc-icon" id="showCalc" title="คำนวณจากจำนวนวัน">🧮</span>
                </div>
              </div>

              <div class="med-actions">
                <button id="addOne" type="button" class="btn-add">เพิ่มยา</button>
                <button id="clearOne" type="button" class="btn-clear">ล้าง</button>
              </div>
            </div>

            <!-- Calculator Panel (แสดงเมื่อคลิก 🧮) -->
            <div id="calcPanel" class="calc-panel hidden">
              <div class="calc-panel-header">
                <span class="calc-panel-title">🧮 คำนวณจำนวนยา</span>
                <button id="closeCalc" class="calc-close">✕</button>
              </div>
              <div class="calc-panel-body">
                <div class="calc-row">
                  <input id="calcDoseInput" type="number" min="0" step="0.5" placeholder="Dose" class="calc-input-small" />
                  <span class="calc-separator">×</span>
                  <input id="calcFreqInput" placeholder="q12h, tid" class="calc-input-medium" />
                  <span class="calc-separator">×</span>
                  <input id="medDuration" type="number" min="1" max="365" placeholder="จำนวนวัน" class="calc-input-small" />
                  <span class="calc-info">วัน</span>
                  <button id="calcMedQty" type="button" class="btn-calc">คำนวณ</button>
                </div>
                <div id="calcResultRow" class="calc-result-row hidden">
                  <span class="calc-result-text">ผลลัพธ์: <strong id="calcResultValue">-</strong></span>
                  <button id="applyCalcResult" type="button" class="btn-apply-calc">✓ ใช้ค่านี้</button>
                </div>
              </div>
            </div>
          </div>

          <datalist id="formulary"></datalist>
          <datalist id="freqList"></datalist>
        </div>

        <div id="infusionOrder" class="hidden">
          <div class="row preset-bar">
            <button id="presetCSCI1" type="button">Preset: Morphine (CSCI)</button>
            <button id="presetCSCI2" type="button">Preset: Morphine + Midazolam</button>
            <button id="presetCSCI3" type="button">Preset: Morphine + Midazolam + Hyoscine</button>
          </div>
          <div id="mixRows"></div>
          <datalist id="formularyIvSc"></datalist>
          <div class="row" id="mixBar">
            <select id="mixRoute" title="Route"><option value="CSCI">CSCI</option><option value="IV">IV</option></select>
            <select id="mixDevice" title="Device"></select>
            <input id="mixDiluent" placeholder="Diluent (เช่น NSS)" title="Diluent" />
            <input id="mixFinalVol" type="number" min="1" placeholder="Vol (mL)" title="Final volume" />
            <input id="mixDuration" type="number" min="1" value="24" placeholder="Dur (h)" title="Duration" />
            <span id="mixRateWrap" class="hidden"><input id="mixRate" type="number" min="0" step="0.1" placeholder="mL/h" title="Rate (mL/h)" /></span>
            <span id="mixMmWrap"><input id="mixMmPerHr" type="number" min="0" step="0.1" placeholder="mm/h" title="Set speed (mm/h)" /></span>
            <span id="mixDiaWrap"><input id="mixDia" type="number" min="0" step="0.1" placeholder="Ø mm" title="Syringe diameter (mm)" /></span>
            <input id="mixSite" placeholder="Site" title="Site" />
            <input id="mixQty" type="number" min="1" placeholder="#" title="จำนวน (bag)" />
          </div>
          <div class="row">
            <button id="mixAdd" class="btn-primary" type="button">Add to Med List</button>
          </div>
        </div>

        <div id="medList"></div>
        <div id="tddSummary" class="sub"></div>
      </section>


      

      <details class="card">
        <summary>Conversion: Oral Morphine → Fentanyl patch</summary>
        <div class="grid mt-8">
          <label>Oral Morphine (mg/24h) <input id="oralMorphine24" type="number" min="0" /></label>
          <label>Opioid-naïve?
            <select id="isNaiveForPatch">
              <option>No</option>
              <option>Yes</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button id="convSuggest" type="button">Suggest patch</button>
        </div>
        <div id="convResult"></div>
      </details>

      <section class="card">
        <h2>ติดตาม (Follow-up)</h2>
        <div class="grid">
          <label>วันที่ <input id="fuDate" type="date" /></label>
          <label>สถานที่ติดตาม <input id="fuSite" /></label>
          <label>โทร <input id="fuTel" /></label>
        </div>
      </section>

      <section class="actions">
        <button id="copyHis" type="button">Copy HIS Note</button>
        <button id="previewBtn" type="button">แสดงตัวอย่าง PDF</button>
        <button id="exportPdf" type="button">Export PDF</button>
        <button id="exportData" type="button">Export ข้อมูล (.json)</button>
        <button id="exportExcel" type="button">Export รายการยา (Excel)</button>
        <button id="importData" type="button">Import ข้อมูล (.json)</button>
        <button id="openDrive" type="button">เปิดโฟลเดอร์ Drive</button>
        <button id="togglePrintSettings" type="button">⚙️ ตั้งค่าการพิมพ์</button>
        <input id="importFile" type="file" accept="application/json,.json" style="display:none" />
        <button id="clearAll" class="danger" type="button">ล้างทั้งหมด</button>
      </section>

      <!-- Print Settings Panel -->
      <section id="printSettingsPanel" class="card print-settings-panel hidden">
        <div class="print-settings-header">
          <h2>⚙️ ตั้งค่าการพิมพ์</h2>
          <button id="closePrintSettings" class="settings-close">✕</button>
        </div>

        <div class="print-settings-grid">
          <!-- Typography Settings -->
          <div class="settings-group">
            <h3 class="settings-group-title">📝 ฟอนต์และขนาด</h3>
            <div class="settings-row">
              <label class="settings-label">
                <span>Font Family</span>
                <select id="printFont" class="settings-input">
                  <option>TH SarabunPSK</option>
                  <option>TH Sarabun New</option>
                  <option>Sarabun</option>
                  <option>Noto Sans Thai</option>
                  <option>Tahoma</option>
                  <option>Arial</option>
                  <option>System</option>
                </select>
              </label>

              <label class="settings-label">
                <span>Font Size <span class="settings-value" id="printSizeValue">16pt</span></span>
                <input id="printSize" type="range" min="4" max="20" step="0.5" value="16" class="settings-slider" />
              </label>

              <label class="settings-label">
                <span>Line Height <span class="settings-value" id="printLineHeightValue">1.35</span></span>
                <input id="printLineHeight" type="range" min="1.10" max="1.60" step="0.05" value="1.35" class="settings-slider" />
              </label>
            </div>
          </div>

          <!-- Layout Settings -->
          <div class="settings-group">
            <h3 class="settings-group-title">📄 เลย์เอาต์</h3>
            <div class="settings-row">
              <label class="settings-label">
                <span>Page Width <span class="settings-value" id="printWidthValue">190mm</span></span>
                <input id="printWidth" type="range" min="150" max="200" step="5" value="190" class="settings-slider" />
              </label>

              <label class="settings-toggle">
                <input id="fitOnePage" type="checkbox" />
                <span class="toggle-label">
                  <strong>Fit to 1 Page</strong>
                  <small>ลดขนาดให้พอดี 1 หน้า</small>
                </span>
              </label>

              <label class="settings-toggle">
                <input id="printWordLike" type="checkbox" checked />
                <span class="toggle-label">
                  <strong>Word-like Layout</strong>
                  <small>เว้นวรรคและจัดข้อความแบบ MS Word</small>
                </span>
              </label>
            </div>
          </div>

          <!-- Footer Settings -->
          <div class="settings-group">
            <h3 class="settings-group-title">📌 ส่วนท้าย</h3>
            <div class="settings-row">
              <label class="settings-toggle">
                <input id="printShowPrinted" type="checkbox" checked />
                <span class="toggle-label">
                  <strong>แสดงวันที่พิมพ์</strong>
                  <small>Printed on...</small>
                </span>
              </label>

              <label class="settings-toggle">
                <input id="printShowPgn" type="checkbox" />
                <span class="toggle-label">
                  <strong>แสดงเลขหน้า</strong>
                  <small>Page X of Y</small>
                </span>
              </label>
            </div>
          </div>
        </div>

        <div class="print-settings-footer">
          <button id="resetPrintSettings" type="button" class="btn-reset">↺ รีเซ็ตค่าเริ่มต้น</button>
          <button id="applyPrintSettings" type="button" class="btn-primary">✓ ใช้การตั้งค่า</button>
        </div>
      </section>

      <section id="hisBlock" class="card">
        <h2>HIS Note (ตัวอย่าง)</h2>
        <pre id="hisText"></pre>
      </section>

      <section id="printDoc" class="card pdf">
        <div id="pageEstimate" class="page-estimate"></div>
        <div class="print-header">
          <img src="logo.png" class="logo" alt="logo" />
          <div class="heading"><h2>ใบส่งตัวผู้ป่วย Palliative Care</h2></div>
        </div>
        <div class="pdf-meta">
          <div class="kv">
            <div class="k">หน่วยงานต้นทาง</div>
            <div class="v"><span data-bind="fromFacility"></span></div>
            <div class="k">ปลายทาง</div>
            <div class="v"><ul id="pdfToList" class="ul-compact"></ul></div>
            <div class="k">วันที่ส่งต่อ</div>
            <div class="v"><span data-bind="refDate"></span></div>
          </div>
        </div>
        <div id="printFooter"><span class="printed"></span><span class="pgn"></span></div>
        <div class="pdf-cols">
          <div class="col">
            <div class="pdf-section">
              <h3>ข้อมูลผู้ป่วย</h3>
              <div class="kv">
                <div class="k">ชื่อ-สกุล</div><div class="v"><span data-bind="pName"></span></div>
                <div class="k">อายุ</div><div class="v"><span data-bind="pAge"></span> ปี</div>
                <div class="k">HN</div><div class="v"><span data-bind="pHN"></span></div>
                <div class="k">เลขบัตร</div><div class="v"><span data-bind="pCID"></span></div>
                <div class="k">ที่อยู่</div><div class="v"><span data-bind="pAddress"></span></div>
                <div class="k">ผู้ดูแลหลัก</div><div class="v"><span data-bind="careName"></span> (ความสัมพันธ์: <span data-bind="careRelation"></span>, โทร: <span data-bind="careTel"></span>)</div>
              </div>
            </div>
            <div class="pdf-section">
              <h3>วัตถุประสงค์ & ACP</h3>
              <p>วัตถุประสงค์: <span data-bind="purposeList"></span></p>
              <p>ACP: <span data-bind="acpList"></span></p>
            </div>
          </div>
          <div class="col">
            <div class="pdf-section">
              <h3>จิตสังคม–จิตวิญญาณ</h3>
              <p>ผู้รับทราบ: <span data-bind="informedBy"></span> | การอยู่อาศัย: <span data-bind="living"></span></p>
              <p>ความต้องการ/ห่วงกังวล: <span data-bind="concerns"></span></p>
              <p id="pdfLinePerPatient">Perception (ผู้ป่วย): <span data-bind="perceptionPatient"></span></p>
              <p id="pdfLinePerFamily">Perception (ญาติ): <span data-bind="perceptionFamily"></span></p>
              <p id="pdfLineConspiracy">Conspiracy of silence: <span data-bind="conspiracy"></span></p>
            </div>
            <div class="pdf-section">
              <h3>ข้อมูลทางการแพทย์</h3>
              <p id="pdfLineDx">Dx: <span data-bind="dx"></span> | PPS: <span data-bind="pps"></span>% | GFR: <span data-bind="gfr"></span>% | Hct: <span data-bind="hct"></span>% | Alb: <span data-bind="alb"></span> g/dL</p>
              <p id="pdfLineSymptoms">อาการ: ปวดบริเวณ <span data-bind="painSite"></span> (PS <span data-bind="painScore"></span>/10); Dyspnea <span data-bind="dyspneaScore"></span>/10 (RR <span data-bind="vsRR"></span>/นาที); คลื่นไส้/อาเจียน: <span data-bind="nausea"></span>; อื่นๆ: <span data-bind="others"></span></p>
              <p id="pdfLineVS">V/S: BP <span data-bind="bpSys"></span>/<span data-bind="bpDia"></span> mmHg; HR <span data-bind="hr"></span>/นาที</p>
            </div>
          </div>
        </div>
        <div class="pdf-section">
          <h3>แผนยา</h3>
          <ul id="pdfMeds"></ul>
          <p id="pdfTdd" class="muted"></p>
        </div>
        <div class="pdf-section">
          <h3>ติดตาม</h3>
          <p><span data-bind="fuDate"></span> — <span data-bind="fuSite"></span> (โทร <span data-bind="fuTel"></span>)</p>
          
        </div>
        <div class="pdf-footer">
          <p>ผู้บันทึก: _____________________________ วันที่: ____________________</p>
        </div>
      </section>

      <div id="snack"></div>
    </main>

    <!-- html2pdf for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPnp8nTKpWsyQufgqKp5r9mS1ANVmX8p1c+5f5m1tGqVf9y2o8aLVYF0i9T6Yg1n9lVfX8u5z6xq1F6s5Mg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="app.js"></script>
    <script src="med-calculator.js"></script>
  </body>
  </html>
